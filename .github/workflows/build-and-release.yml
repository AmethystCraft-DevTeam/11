# .github/workflows/build-and-release.yml
name: Build and Release Electron App (Win/Linux) # ä½ çš„å·¥ä½œæµåç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨GitHub Actionsé¡µé¢

on:
  push:
    # branches:
    #   - main # è¿™ä¸ªå¯ä»¥ä¿ç•™ç”¨äºæ™®é€šCIï¼ˆæ¯”å¦‚æ¯æ¬¡æäº¤éƒ½è·‘æµ‹è¯•ï¼‰ï¼Œä½†è¯·æ³¨æ„ï¼Œå®ƒä¸ä¼šè§¦å‘Releaseã€‚
               # Release åªä¼šå›  Tag è§¦å‘ã€‚

    tags:
      - 'v*.*.*' # â­ æ ¸å¿ƒï¼åªæœ‰å½“ä½ æ¨é€ v1.0.0, v2.3.4 ç­‰æ ¼å¼çš„ Tag æ—¶ï¼Œæ‰ä¼šè§¦å‘å®Œæ•´çš„å‘å¸ƒæµç¨‹ã€‚
                 # è¿™æ˜¯è‡ªåŠ¨å‘å¸ƒ Releases çš„â€œå¯åŠ¨é”®â€ï¼

  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨è§¦å‘è¿™ä¸ªå·¥ä½œæµï¼Œæ–¹ä¾¿æµ‹è¯•æˆ–éœ€è¦æ‰‹åŠ¨å¹²é¢„å‘å¸ƒæ—¶ä½¿ç”¨ã€‚

jobs: # ğŸ‘‡ ä¸‹é¢æ˜¯å…·ä½“çš„å·¥ä½œä»»åŠ¡
  build-win-linux:
    name: Build for Windows & Linux # ä»»åŠ¡åç§°
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„Ubuntuç³»ç»Ÿä¸Šè¿è¡Œæ­¤ä»»åŠ¡

    steps: # å…·ä½“çš„æ­¥éª¤
      - name: Checkout code # æ‹‰å–ä½ çš„ä»£ç 
        uses: actions/checkout@v4

      - name: Set up Node.js # è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22.x # å»ºè®®ä½¿ç”¨LTSç‰ˆæœ¬ï¼Œä¸ä½ æœ¬åœ°å¼€å‘ç¯å¢ƒä¸€è‡´
        
      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install pnpm dependency
        run: pnpm install

      - name: Build for Windows and Linux # æ‰§è¡Œä¹‹å‰å®šä¹‰çš„æ‰“åŒ…è„šæœ¬
        # å‡è®¾ä½ çš„ npm run electron:build å‘½ä»¤ä¼šæ‰“åŒ…å‡º Windows å’Œ Linux çš„æ–‡ä»¶åˆ° dist/ ç›®å½•
        run: npm run electron:build 

      - name: Upload Windows & Linux artifacts # å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶ä½œä¸ºâ€œå·¥ä½œæµäº§ç‰©â€ä¸Šä¼ ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
        uses: actions/upload-artifact@v4
        with:
          name: win-linux-build # äº§ç‰©åç§°
          path: dist/ # electron-builder é»˜è®¤æ‰“åŒ…å¥½çš„æ–‡ä»¶éƒ½åœ¨ dist ç›®å½•ï¼ˆè¿™é‡Œä¸å˜ï¼‰

  release:
    name: Create GitHub Release and Upload Win/Linux Assets # åˆ›å»ºå¹¶ä¸Šä¼ åˆ° GitHub Release
    needs: [build-win-linux] # â­ å…³é”®ï¼åªä¾èµ–äº Windows å’Œ Linux çš„æ„å»ºä»»åŠ¡æˆåŠŸå®Œæˆ
    runs-on: ubuntu-latest # è¿™ä¸ªä»»åŠ¡å¯ä»¥åœ¨ Ubuntu ä¸Šå®Œæˆ

    # â­ åªæœ‰å½“å·¥ä½œæµæ˜¯ç”± Git Tag ï¼ˆä»¥ 'refs/tags/' å¼€å¤´çš„å¼•ç”¨ï¼‰è§¦å‘æ—¶ï¼Œæ‰æ‰§è¡Œæ­¤å‘å¸ƒæ­¥éª¤ã€‚
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download Windows & Linux artifacts # ä¸‹è½½ä¹‹å‰ä¸Šä¼ çš„ Windows å’Œ Linux æ‰“åŒ…äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: win-linux-build
          path: dist_electron/ # â­ æ ¸å¿ƒä¿®æ”¹ï¼šä¸‹è½½äº§ç‰©åˆ° dist_electron/ ç›®å½•


      - name: Create Release and Upload Assets # ä½¿ç”¨ softprops/action-gh-release è‡ªåŠ¨åŒ–åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨æä¾›çš„ Tokenï¼Œæœ‰æƒé™åœ¨ä½ çš„ä»“åº“åˆ›å»º Release
        with:
          tag_name: ${{ github.ref_name }} # Release çš„ Tag åç§°ï¼Œç›´æ¥ä½¿ç”¨è§¦å‘å®ƒçš„ Git Tag åç§°
          name: Release ${{ github.ref_name }} # Release çš„æ ‡é¢˜
          draft: false # â­ è®¾ä¸º falseï¼Œè¡¨ç¤ºç›´æ¥å‘å¸ƒï¼Œæ— éœ€æ‰‹åŠ¨ç¡®è®¤ï¼ˆè°¨æ…æ“ä½œï¼Œç¡®ä¿æµ‹è¯•æ— è¯¯ï¼‰
          prerelease: false # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: | # â­ æ ¸å¿ƒä¿®æ”¹ï¼šæ‰€æœ‰æ–‡ä»¶è·¯å¾„éƒ½æ”¹ä¸ºä» dist_electron/ å¼€å§‹å¯»æ‰¾
            dist_electron/*.exe       # Windows å¯æ‰§è¡Œæ–‡ä»¶ (ä¾‹å¦‚ YourApp Setup 1.0.0.exe)
            dist_electron/*.AppImage  # Linux AppImage æ–‡ä»¶ (ä¾‹å¦‚ YourApp-1.0.0-x86_64.AppImage)
            dist_electron/*.deb       # Linux Debian/Ubuntu åŒ… (ä¾‹å¦‚ yourapp_1.0.0_amd64.deb)
            dist_electron/*.rpm       # Linux RedHat/Fedora åŒ… (ä¾‹å¦‚ yourapp-1.0.0.x86_64.rpm)
            dist_electron/latest.yml  # å¦‚æœä½¿ç”¨ electron-updaterï¼Œè¿™ä¸ªé€šå¸¸æ˜¯è·¨å¹³å°çš„æ›´æ–°å…¥å£æˆ–Windows/macOSçš„
            dist_electron/latest-linux.yml # å¯èƒ½ç”± electron-builder ä¸º Linux ç”Ÿæˆçš„ç‰¹å®šæ›´æ–°ä¿¡æ¯æ–‡ä»¶
            dist_electron/*.yml       # åŒ…å«æ‰€æœ‰ *.yml æ–‡ä»¶ï¼Œä»¥é˜²ä¸‡ä¸€æœ‰å…¶ä»–ymlæ›´æ–°æ–‡ä»¶
            dist_electron/*.blockmap # electron-builder å¯èƒ½ä¼šç”Ÿæˆ .blockmap æ–‡ä»¶ç”¨äºå·®åˆ†æ›´æ–°
