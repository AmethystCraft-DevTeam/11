# .github/workflows/build-and-release.yml
name: Build and Release Electron App # ä½ çš„å·¥ä½œæµåç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨GitHub Actionsé¡µé¢

on:
  push:
    branches:
      - main # å½“ä½ æ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œè§¦å‘è¿™ä¸ªå·¥ä½œæµ

  # å¦‚æœä½ å¸Œæœ›é€šè¿‡æ‰“ Tag å‘å¸ƒï¼Œå¯ä»¥æ”¹ä¸ºä»¥ä¸‹é…ç½®ï¼š
  # push:
  #   tags:
  #     - 'v*' # å½“ä½ æ‰“ v1.0.0, v2.0.1 ç­‰æ ¼å¼çš„ Tag æ—¶è§¦å‘

  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨è§¦å‘è¿™ä¸ªå·¥ä½œæµï¼Œæ–¹ä¾¿æµ‹è¯•

jobs: # ğŸ‘‡ ä¸‹é¢æ˜¯å…·ä½“çš„å·¥ä½œä»»åŠ¡
  build-win-linux:
    name: Build for Windows & Linux # ä»»åŠ¡åç§°
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„Ubuntuç³»ç»Ÿä¸Šè¿è¡Œæ­¤ä»»åŠ¡

    steps: # å…·ä½“çš„æ­¥éª¤
      - name: Checkout code # æ‹‰å–ä½ çš„ä»£ç 
        uses: actions/checkout@v4

      - name: Set up Node.js # è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22.15 # å»ºè®®ä½¿ç”¨LTSç‰ˆæœ¬ï¼Œä¸ä½ æœ¬åœ°å¼€å‘ç¯å¢ƒä¸€è‡´

      - name: Install dependency # å®‰è£…pnpm
        run: npm install
        
      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install pnpm dependency
        run: pnpm install


      - name: Build for Windows and Linux # æ‰§è¡Œä¹‹å‰å®šä¹‰çš„æ‰“åŒ…è„šæœ¬
        run: npm run build:win-linux

      - name: Upload Windows & Linux artifacts # å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶ä½œä¸ºâ€œå·¥ä½œæµäº§ç‰©â€ä¸Šä¼ ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
        uses: actions/upload-artifact@v4
        with:
          name: win-linux-build # äº§ç‰©åç§°
          path: dist/ # electron-builder é»˜è®¤æ‰“åŒ…å¥½çš„æ–‡ä»¶éƒ½åœ¨ dist ç›®å½•

  build-mac:
    name: Build for macOS # macOSçš„æ‰“åŒ…ä»»åŠ¡
    runs-on: macos-latest # macOS å¹³å°å¿…é¡»åœ¨ macOS ç³»ç»Ÿä¸Šæ‰“åŒ…ï¼

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build for macOS # æ‰§è¡Œæ‰“åŒ… macOS çš„è„šæœ¬
        run: npm run build:mac

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-build # äº§ç‰©åç§°
          path: dist/

  release:
    name: Create GitHub Release and Upload Assets # åˆ›å»ºå¹¶ä¸Šä¼ åˆ° GitHub Release
    needs: [build-win-linux, build-mac] # ç¡®ä¿è¿™ä¸¤ä¸ªæ‰“åŒ…ä»»åŠ¡éƒ½æˆåŠŸå®Œæˆåæ‰æ‰§è¡Œæ­¤ä»»åŠ¡
    runs-on: ubuntu-latest # è¿™ä¸ªä»»åŠ¡å¯ä»¥åœ¨ Ubuntu ä¸Šå®Œæˆ

    steps:
      - name: Get package.json version # è·å– package.json ä¸­çš„ç‰ˆæœ¬å·ï¼Œä½œä¸º Release çš„ Tag
        id: get_version
        run: echo "APP_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Download Windows & Linux artifacts # ä¸‹è½½ä¹‹å‰ä¸Šä¼ çš„ Windows å’Œ Linux æ‰“åŒ…äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: win-linux-build
          path: dist/ # ä¸‹è½½åˆ° dist/ ç›®å½•

      - name: Download macOS artifacts # ä¸‹è½½ macOS æ‰“åŒ…äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: mac-build
          path: dist/ # ä¹Ÿä¸‹è½½åˆ° dist/ ç›®å½•ï¼Œå› ä¸ºæ–‡ä»¶åä¸ä¸€æ ·ï¼Œä¸ä¼šå†²çª

      - name: Create Release and Upload Assets # ä½¿ç”¨ softprops/action-gh-release è‡ªåŠ¨åŒ–åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨æä¾›çš„ Tokenï¼Œæœ‰æƒé™åœ¨ä½ çš„ä»“åº“åˆ›å»º Release
        with:
          tag_name: v${{ env.APP_VERSION }} # Release çš„ Tag åç§°ï¼Œæ¯”å¦‚ v1.0.0
          name: Release v${{ env.APP_VERSION }} # Release çš„æ ‡é¢˜
          draft: true # é»˜è®¤åˆ›å»ºä¸ºè‰ç¨¿ Releaseã€‚ä½ å¯ä»¥æ‰‹åŠ¨å» GitHub å‘å¸ƒå®ƒã€‚
                      # å¦‚æœä½ å¸Œæœ›è‡ªåŠ¨å‘å¸ƒï¼Œæ”¹ä¸º falseã€‚ä½†è°¨æ…æ“ä½œï¼Œç¡®ä¿æµ‹è¯•æ— è¯¯ã€‚
          prerelease: false # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: | # è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ”¯æŒ glob æ¨¡å¼ï¼Œä¼šæŠŠ dist/ ä¸‹çš„æ‰“åŒ…äº§ç‰©éƒ½ä¸Šä¼ 
            dist/*.exe
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.dmg
